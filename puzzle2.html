<html>
  <head>
    <script src="https://rawgit.com/aframevr/aframe/master/dist/aframe-master.min.js"></script> 
  </head>
  <body>
    <a-scene id='scene'>
        <a-sky id='sky' src='models/background.jpg'></a-sky>
            <a-camera user-height='0'></a-camera>
            <a-entity id="controller" daydream-controls>
                <a-entity id='rc' raycaster="objects: .clickable; showLine: true; interval:10; far:30" position='0 0 0' material='color: red'></a-entity>
            </a-entity>

            <a-entity id='winnerSound' sound='src:url(models/sounds/winnerEffect.mp3); volume:0.5' position='0 0 0'></a-entity>
            <a-entity id='correctSound' sound='src:url(models/sounds/correctEffect.mp3)' position='0 0 0'></a-entity>
            <a-entity id='errorSound' sound='src: url(models/sounds/errorEffect.mp3); volume:1.5' position='0 0 0'></a-entity>
        
            <a-entity id='mickey' visible='false'>
                <a-entity obj-model= 'obj: url(models/balloons/model.obj); mtl: url(models/balloons/materials.mtl)' position='0.55 2.7 -4' scale='2 2 2 ' rotation='0 90 0'>
                </a-entity>
                <a-entity obj-model= 'obj: url(models/mickeyMouse/model.obj); mtl: url(models/mickeyMouse/materials.mtl)' position='0 0.5 -4' scale='2 2 2 ' rotation='0 90 0'></a-entity>
                <a-animation attribute='rotation'
                             from='0 -20 0'
                             to='0 20 0'
                             dur='2000'
                             repeat='indefinite'></a-animation>
            </a-entity>   
        
            <a-text id='finalText'value='wow' color='red' position='-3 2 -3' visible='false'></a-text>
        
            <a-text id='contatoreErrori' value='Errori: 0' font="exo2semibold" position='-0.5 -2.5 -5' color='red'></a-text>
                
            <a-entity id="table" class='clickable'  position="0 0 -5" >
                <a-box id='yellow' class='table' color="yellow" opacity='0.5' height="1" width="4" rotation="0 0 0" depth="0.01" position="-0.5 2.5 0"></a-box>
                <a-box id='pink'class='table' color="pink" opacity='0.5' height="1" width="1" rotation="0 0 0" depth="0.01" position="0 1.5"></a-box>
                <a-box id='red' class='table' color="red" opacity='0.5' height="2" width="2" rotation="0 0 0" depth="0.01" position="-1.5 1 0"></a-box>
                <a-box id='grey'class='table' color="grey" opacity='0.5' height="2" width="1" rotation="0 0 0" depth="0.01" position="1 -1 0"></a-box>
                <a-box id='violet'class='table' color="violet" opacity='0.5' height="3" width="1" rotation="0 0 0" depth="0.01" position="2 -0.5 0"></a-box>
                <a-entity id='blue' color="blue"  class='table'>
                    <a-box color="blue" class='table' opacity='0.5' height="2" width="1" rotation="0 0 0" depth="0.01" position="2 2 0"></a-box>
                    <a-box color="blue" class='table' opacity='0.5' height="1" width="1" rotation="0 0 0" depth="0.01" position="1 1.5 0"></a-box>
                </a-entity>
                <a-entity id='green' color="green"  class='table'>
                    <a-box color="green" class='table' opacity='0.5' height="2" width="1" rotation="0 0 0" depth="0.01" position="0 0 0"></a-box>
                    <a-box color="green" class='table' opacity='0.5' height="1" width="1" rotation="0 0 0" depth="0.01" position="1 0.5 0"></a-box>
                </a-entity>
                <a-entity id='orange' color="orange"  class='table'>
                    <a-box color="orange" class='table' opacity='0.5' height="2" width="2" rotation="0 0 0" depth="0.01" position="-1.5 -1 0"></a-box>
                    <a-box color="orange" class='table' opacity='0.5' height="1" width="1" rotation="0 0 0" depth="0.01" position="0 -1.5 0"></a-box>
                </a-entity>
                
            </a-entity>
        
            <!--pezzi sparsi-->     
            <a-entity id='objects' class='clickable'>
                <a-box id='yellowPiece' class='piece'  color="yellow" height="1" width="4" depth="0.3" rotation="0 0 90" position="5 0.8 -5" value='90' ></a-box>
                <a-box id='pinkPiece' class='piece' color="pink" height="1" width="1" depth="0.3" rotation="0 0 0" position="-2 -3.5 -5" value='361' ></a-box>
                <a-box  id='redPiece' class='piece' color="red" height="2" width="2" depth="0.3" rotation="0 0 0" position="1 5.5 -5" value='361'></a-box> 
                <a-box  id='greyPiece' class='piece' color="grey" height="2" width="1" depth="0.3" rotation="0 0 90" position="5 5.5 -5" value='90'></a-box> 
                <a-box  id='violetPiece' class='piece' color="violet" height="3" width="1" depth="0.3" rotation="0 0 0" position="-5 -3.5 -5" value='0'></a-box> 
                <a-entity id='bluePiece' color='blue' class='piece' position="3 -3.5 -5" rotation='0 0 90' value='180'>
                    <a-box color="blue" class='piece'  height="2" width="1" depth="0.3" rotation="0 0 0" position="0 0 0"></a-box>
                    <a-box color="blue" class='piece' height="1" width="1" depth="0.3" rotation="0 0 0" position="-1 0.5 0"></a-box>
                </a-entity>
                <a-entity id='greenPiece' color='green' class='piece' position="-4 5 -5" rotation='0 0 0' value='270'><!-- controllare ROTAZIONE!!!!-->
                    <a-box color="green" class='piece'  height="2" width="1" depth="0.3" rotation="0 0 0" position="0 0 0"></a-box>
                    <a-box color="green" class='piece'  height="1" width="1" depth="0.3" rotation="0 0 0" position="-1 0.5 0"></a-box>
                </a-entity>
                <a-entity id='orangePiece' color='orange' class='piece' position="-4.5 1 -5" rotation='0 0 90' value='270'><!-- controllare ROTAZIONE!!!!-->
                    <a-box color="orange" class='piece'  height="2" width="2" depth="0.3" rotation="0 0 0" position="0 0 0"></a-box>
                    <a-box color="orange" class='piece' height="1" width="1" depth="0.3" rotation="0 0 0" position="-1.5 0.5 0"></a-box>
                </a-entity>
            </a-entity>
            
        </a-scene>
      
      <script>
        var winnerSound=document.querySelector('#winnerSound');
        var errorSound=document.querySelector('#errorSound');
        var correctSound=document.querySelector('#correctSound');
        var objects=document.querySelector('#objects');
        var raycaster=document.querySelector('#rc');
        var controller=document.querySelector('#controller');
        var scene=document.querySelector('#scene');
        var mickey=document.querySelector('#mickey');
        var endingText=document.querySelector('#finalText');
        var numOfPieces= 8;
        var numOfTable= 8;
        var countNumeroDiPezziOK=0;
        var piecesFocused=new Array(numOfPieces);
        for(var i=0; i<numOfPieces; i++){
            piecesFocused[i]=false;
        }
        
        var tableFocused= new Array(numOfTable);
        for(var i=0; i<numOfTable; i++){
            tableFocused[i]=false;
        }
        
        var greenPiece=document.querySelector('#greenPiece');
        var pinkPiece=document.querySelector('#pinkPiece');
        var redPiece=document.querySelector('#redPiece');
        var bluePiece=document.querySelector('#bluePiece');
        var yellowPiece=document.querySelector('#yellowPiece');
        var greyPiece=document.querySelector('#greyPiece');
        var violetPiece=document.querySelector('#violetPiece');
        var orangePiece=document.querySelector('#orangePiece');
        
        var pieces= new Array(numOfPieces);
        pieces[0]=greenPiece;
        pieces[1]=pinkPiece;
        pieces[2]=redPiece;
        pieces[3]=bluePiece;
        pieces[4]=yellowPiece;
        pieces[5]=greyPiece;
        pieces[6]=violetPiece;
        pieces[7]=orangePiece;
        
        var greeen=document.querySelector('#green');
        var pink=document.querySelector('#pink');
        var red=document.querySelector('#red');
        var blue=document.querySelector('#blue');
        var yellow=document.querySelector('#yellow');
        var grey=document.querySelector('#grey');
        var violet=document.querySelector('#violet');
        var orange=document.querySelector('#orange');
        
        var table= new Array(numOfTable);
        table[0]=greeen;
        table[1]=pink;
        table[2]=red;
        table[3]=blue;
        table[4]=yellow;
        table[5]=grey;
        table[6]=violet;
        table[7]=orange;
        
        console.log('value è= '+ table[0].getAttribute('value'));
        var focused= -1; //ricordarsi di reimpostarla a null dopo la funzione!!!
        var textPosition= document.createElement('a-text');
        textPosition.setAttribute('visible', 'false');
        scene.appendChild(textPosition);
        var errorCountText= document.querySelector('#contatoreErrori');
        var errorCounter=0;
        
        // cambia pathfocused e tablefocused in true (per table fa un bel giro e mette anche su false)
        raycaster.addEventListener('raycaster-intersection', function(e){
            for (var i=0; i<numOfPieces; i ++){
                if (checkIfContainedInPath(e, i)){
                    piecesFocused[i]=true;
                }
            }
            var isContained=false;
            for (var i=0; i<numOfTable; i ++){
                if(checkIfContainedInTable(e, i)) 
                    isContained=true;
            }
            if(!isContained)
                for(var i=0; i<numOfTable; i++){
                    tableFocused[i]=false;
                }
        })
        
        //funzione che controlla che elemento i-esimo di path sia contenuto tra gli elementi dell'evento e
        function checkIfContainedInPath(e , i){
            for(var j=0; j<e.detail.els.length; j++){
                if (e.detail.els[j].getAttribute('color')==pieces[i].getAttribute('color') && e.detail.els[j].getAttribute('class')=='piece') { 
                    console.log('hai intersecato l oggetto: ' + pieces[i].getAttribute('id'));
                    return true;
                }
            }
        }
        
        //funzione che controlla che elemento i-esimo di table sia contenuto tra gli elementi dell'evento e ritorna true se un pezzo del table è focused, false altrimenti.
        function checkIfContainedInTable(e, i){
            for(var j=0; j<e.detail.els.length; j++){
                if (e.detail.els[j].getAttribute('color')==table[i].getAttribute('color') && e.detail.els[j].getAttribute('class')=='table'){
                    tableFocused[i]=true;
                    console.log('un pezzo del table è focused: ' +table[i].getAttribute('color'));
                    for(var z=0; z<numOfTable; z++){
                        if(z!=i)
                        tableFocused[z]=false;
                    }
                    return true;
                }
            }
            return false;
        }
        
        //cambia piece focused in false quando i raycaster concludono l'intersezione
        for (var i=0; i<numOfPieces; i++){
            pieces[i].addEventListener('raycaster-intersected-cleared', function(){
                for(var j=0; j<numOfPieces; j++){
                    piecesFocused[j]=false;
                }
            })
        }
        
        
        //attende che clicchi il trackpad su una figura!
        controller.addEventListener('trackpaddown', function(){
            for (var i=0; i<numOfPieces; i++){
                if (piecesFocused[i]==true){
                    focused=i;
                    textPosition.setAttribute('value', pieces[focused].getAttribute('position').x +' '+pieces[focused].getAttribute('position').y +' '+pieces[focused].getAttribute('position').z);
                    //console.log('il pezzo da attaccare focused è:' + focused + 'posizione inniziale= ' + pieces[focused].getAttribute('position').x +' '+pieces[focused].getAttribute('position').y +' '+pieces[focused].getAttribute('position').z);
                }
            }
            if (focused==-1) {
                errorSound.components.sound.playSound();
                console.log('non puntavi su nessun pezzo quando hai cliccato');
                return; //return se nessun pezzo è focalizzato!
                }   
            objects.removeChild(pieces[focused]);
            raycaster.appendChild(pieces[focused]);
            pieces[focused].setAttribute('scale', '0.6 0.6 0.6');
            pieces[focused].setAttribute('position', '0 0 -4.2');
            controller.addEventListener('trackpadup', doTrackpadUp);
            scene.addEventListener('trackpadUpFinished', removeListeners);
        })
        
        function removeListeners(){
            focused=-1;
            controller.removeEventListener('trackpadup', doTrackpadUp);
            scene.removeEventListener('trackpadUpFinished',removeListeners);
        }
        
        //funzione per quando rilascio il trackpad, deve controllare se sono o no sull'oggetto desideraro. nel caso lascio giù l'oggetto, altrimenti lo faccio tornare alla posizione iniziale. alla fine emette un trackpadUpFinisced sulla scena.
        function doTrackpadUp(){
            console.log('hai rilasciato il trackpad e sei nella funzione dotrackpadup e table focused = ' + tableFocused[focused] + ' e focused = ' + focused);
            raycaster.removeChild(pieces[focused]);
            pieces[focused].setAttribute('scale','1 1 1');
            if(tableFocused[focused]==true && checkRotation()){//se posto ok + aggioungere funzione checkrotation
                console.log('bravo, hai rilasciato nel posto giusto');
                table[focused].appendChild(pieces[focused]);
                pieces[focused].setAttribute('position', '0 0 0');
                pieces[focused].setAttribute('rotation', '0 0 0');
                pieces[focused].setAttribute('opacity', '1');
                correctSound.components.sound.playSound();
                countNumeroDiPezziOK++;
                if (countNumeroDiPezziOK==table.length){
                    console.log('sono nell IF FINALE e num di pezzi ok = ' + countNumeroDiPezziOK + '   lunghezza di table.lenght= ' + table.length);
                    endGame();
                }
            }
            else{
                errorSound.components.sound.playSound();
                console.log('hai rilasciato nel posto sbagliato');
                objects.appendChild(pieces[focused]);
                console.log('posizione dove dovrebbe essere rilasciato l oggetto: ' + textPosition.getAttribute('value') );
                pieces[focused].setAttribute('position', textPosition.getAttribute('value'));
                errorCounter++;
                errorCountText.setAttribute('value', 'Errori: '+ errorCounter);
            }
            scene.emit('trackpadUpFinished');
        }
        //BISOGNEREBBE MIGLIORARE IL CONTROLLO PER I PEZZI QUADRATI!!!!
        
        //funzione per finire la partita
        function endGame(){
            console.log('giocoFinito');
            for(var i=0; i<table.length; i++){
                table[i].setAttribute('visible', false);
                pieces[i].setAttribute('visible', false);
            }
            errorCountText.setAttribute('visible',false);
            mickey.setAttribute('visible',true);
            endingText.setAttribute('visible',true);
            endingText.setAttribute('value', 'Complimenti, hai completato il livello! \n  Hai commesso '+ errorCounter + ' errori');
            winnerSound.components.sound.playSound();
        } 
          
        //ritorna true se giusto; false altrimenti
        function checkRotation(){
            if(pieces[focused].getAttribute('value')=='361'){
               if((controller.object3D.rotation._z<0.35 && controller.object3D.rotation._z>-0.35) ||                              (controller.object3D.rotation._z>2.7 || controller.object3D.rotation._z< -2.7)||
                    (controller.object3D.rotation._z>1.2 && controller.object3D.rotation._z <1.8 )|| (controller.object3D.rotation._z>-1.8 && controller.object3D.rotation._z<-1.2))
                    return true;
                else return false;
            }
            else if(pieces[focused].childElementCount==0){
                console.log('il pezzo è formato da un solo elemento');
                if(pieces[focused].getAttribute('value')=='0' || pieces[focused].getAttribute('value')=='180'){
                    if((controller.object3D.rotation._z<0.35 && controller.object3D.rotation._z>-0.35) || (controller.object3D.rotation._z>2.7 || controller.object3D.rotation._z<-2.7))
                        return true;
                    else return false;
                }  
                if(pieces[focused].getAttribute('value')=='90'|| pieces[focused].getAttribute('value')=='270'){
                    if((controller.object3D.rotation._z>1.2 && controller.object3D.rotation._z <1.8 )|| (controller.object3D.rotation._z>-1.8 && controller.object3D.rotation._z<-1.2))
                        return true;
                    else return false;
                }
            }
            
            else{
                console.log('il pezzo è formato da più elementi');
                if(pieces[focused].getAttribute('value')=='0'){
                    if(controller.object3D.rotation._z<0.35 && controller.object3D.rotation._z>-0.35)
                        return true;
                    else return false;
                }
                    
                if(pieces[focused].getAttribute('value')=='90'){
                    if(controller.object3D.rotation._z>-1.9 && controller.object3D.rotation._z<-1.25)
                        return true;
                    else return false;
                }
                
                if(pieces[focused].getAttribute('value')=='180'){
                    if(controller.object3D.rotation._z>2.7 || controller.object3D.rotation._z< -2.7)
                        return true;
                    else return false;
                }
                    
                if(pieces[focused].getAttribute('value')=='270'){
                    if(controller.object3D.rotation._z>1.2 && controller.object3D.rotation._z <1.8)
                        return true;
                    else return false;
                }
            }
        }
        
    </script>
  </body>
</html>