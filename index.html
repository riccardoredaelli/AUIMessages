<!DOCTYPE html>
<head>
<title>Wivr</title>
<script src="https://rawgit.com/aframevr/aframe/master/dist/aframe-master.min.js"></script> 
<script src="https://unpkg.com/aframe-curve-component/dist/aframe-curve-component.min.js"></script> 
<script src="js/collidable.js"></script>
<script src="js/three.js"></script>
</head>
 
<body>
  <a-scene id="scene">
    <a-entity id="controller" daydream-controls="hand: right">
         <a-entity id='rc' raycaster="objects: .clickable ; showLine: true; interval:10; far:30" position='0 0 0'material='color: red'></a-entity>
    </a-entity>
  </a-scene>
    <script src='js/level1Costructor.js'></script>
<script>
    
var focused=false;
var controller=document.querySelector("#controller");
var scene=document.querySelector("#scene");
var pathController= false;
var raycaster= document.querySelector('#rc');
var rayPosition;
var spPosition;

var c1=document.querySelector('#c1');
var c2= document.querySelector('#c2');
var c3= document.querySelector('#c3');
var c4= document.querySelector('#c4');
var c5= document.querySelector('#c5');
var countIntersections=0;
var path= new Array();
path[0]=c1;
path[1]=c2; 
path[2]=c3;
path[3]=c4;
path[4]=c5;
    
var arrival= document.createElement('a-sphere');
arrival.setAttribute('radius', '1');
arrival.setAttribute('visible', true);
arrival.setAttribute('color', 'yellow');    
arrival.setAttribute('class', 'clickable');
arrival.setAttribute('position','-8 0 -4');
    
var spStop= document.createElement('a-sphere');
spStop.setAttribute('radius', '1');
spStop.setAttribute('visible', true);
spStop.setAttribute('color', 'red');
spStop.setAttribute('position', '8 0 -4');
spStop.setAttribute('class', 'clickable');

scene.appendChild(spStop);
scene.appendChild(arrival);
    
var r1= document.createElement('a-entity');
r1.setAttribute('raycaster','objects: .clickable');
r1.setAttribute('visible',false);

        
for(var i=0; i<5; i++){
    path[i].addEventListener('raycaster-intersected', function(e){
    if(countIntersections==0){
        console.log('prima intersezione con il path');
        scene.emit('first-intersection');
        rayPosition=e.detail.intersection.point;
        scene.emit('rayPositionUpdated');
    }
    console.log('intersezione con un altro pezzo del path');
    countIntersections++;
    console.log('intersezione e counter= '+ countIntersections );
    })
}
        
for(var i=0; i<2; i++){
    path[i].addEventListener('raycaster-intersected-cleared', function(){
    countIntersections--;
    console.log('fine intersezione e counter= '+ countIntersections );
    if(countIntersections==0)
        console.log('sei fuori dal percorso! e counter= '+ countIntersections);
        scene.emit('intersection-cleared');
    })
}
    

spStop.addEventListener('raycaster-intersected', function (e) {
    if (focused) return;
    focused = true;
    spStop.setAttribute('color','green');
});
    
spStop.addEventListener('raycaster-intersected-cleared', function () {
    focused = false;
    spStop.setAttribute('color','red');
});

//quando interseco la prima volta il path...        
scene.addEventListener('first-intersection', function changePathControllerToTrue(e){
    if (pathController) {
        return;
    }
    pathController = true;
});   

arrival.addEventListener('raycaster-intersected', function(){
    scene.emit('winner');
});
    
function changePathControllerToFalse() {
    console.log('sei uscito dal percorso prima di rilasciare il pulsante!');
    pathController = false;
    spStop.setAttribute('position','8 0 -4');
    spStop.setAttribute('visible','true');
    path.setAttribute('color','green');   
    scene.emit('finished');
    return;
}

function winnerFunction(){
    console.log('intersecato sfera finale!!');
    var scritta=document.createElement('a-text');
    scritta.setAttribute('color', 'red');
    scritta.setAttribute('position', '0 2 -4');
    scritta.setAttribute('value', 'COMPLIMENTI! SEI RIUSCITO A FINIRE IL LIVELLO!!!!');
    scene.appendChild(scritta);
}
    
function updateSpherePosition(){
    spPosition=rayPosition;
    path.setAttribute('color', 'green');
    spStop.setAttribute('visible', true);
    spStop.setAttribute('position', spPosition);    
    controller.removeChild(r1);
    scene.emit('updateFinished');
}
    
function doTrackpadUp(){
    console.log('trackpad rilasciato sul path');
    controller.appendChild(r1); 
    scene.addEventListener('rayPositionUpdated', updateSpherePosition);
    scene.addEventListener('updateFinished', function(){
            scene.removeEventListener('rayPositionUpdated', updateSpherePosition);
    });
    scene.emit('finished');
    console.log('funzione trackpad up finita!');
}
    
controller.addEventListener('trackpaddown', function() {
    if(focused){
        console.log('cliccato sulla pallina iniziale');
        spStop.setAttribute("visible", false);
        path.setAttribute('color', 'yellow');
        
        scene.addEventListener('winner', winnerFunction);
        
        scene.addEventListener('intersection-cleared', changePathControllerToFalse);
        
        controller.addEventListener('trackpadup', doTrackpadUp);
        
        scene.addEventListener('finished', function closeEventListeners(){
            scene.removeEventListener('winner', winnerFunction);
            controller.removeEventListener('trackpadup', doTrackpadUp);
            scene.removeEventListener('intersection-cleared', changePathControllerToFalse);
            console.log('evento emesso e rimossi i listener');
        });
        
        
    }
    else return;
});
    
</script>
</body>