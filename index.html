<!DOCTYPE html>
<head>
<title>Wivr</title>
<script src="https://rawgit.com/aframevr/aframe/master/dist/aframe-master.min.js"></script> 
<script src="https://unpkg.com/aframe-curve-component/dist/aframe-curve-component.min.js"></script> 
<script src="js/collidable.js"></script>
<script src="js/three.js"></script>
</head>
 
<body>
  <a-scene id="scene">
    <a-entity id="controller" daydream-controls="hand: right">
         <a-entity id='rc' raycaster="objects: .clickable ; showLine: true; interval:10; far:30" position='0 0 0'material='color: red'></a-entity>
    </a-entity>
      
      <a-cylinder class='clickable' id="cylinder" position="0 0 -4" radius="0.8" height="16" rotation='0 0 90' color='green'></a-cylinder>
  </a-scene>
<script>
    
var focused=false;
var controller=document.querySelector("#controller");
var scene=document.querySelector("#scene");
var path= document.querySelector('#cylinder');
var pathController= false;
var raycaster= document.querySelector('#rc');
var rayPosition;
var spPosition;
    
var arrival= document.createElement('a-sphere');
arrival.setAttribute('radius', '1');
arrival.setAttribute('visible', true);
arrival.setAttribute('color', 'yellow');    
arrival.setAttribute('class', 'clickable');
arrival.setAttribute('position','-8 0 -4');
    
var spStop= document.createElement('a-sphere');
spStop.setAttribute('radius', '1');
spStop.setAttribute('visible', true);
spStop.setAttribute('color', 'red');
spStop.setAttribute('position', '8 0 -4');
spStop.setAttribute('class', 'clickable');

scene.appendChild(spStop);
scene.appendChild(arrival);
    
var r1= document.createElement('a-entity');
r1.setAttribute('raycaster','objects: .clickable');
r1.setAttribute('visible',false);
    


spStop.addEventListener('raycaster-intersected', function (e) {
    if (focused) return;
    focused = true;
    spStop.setAttribute('color','green');
});
    
spStop.addEventListener('raycaster-intersected-cleared', function () {
    focused = false;
    spStop.setAttribute('color','red');
});

        
path.addEventListener('raycaster-intersected', function changePathControllerToTrue(e){
    console.log('intersezione');
    rayPosition=e.detail.intersection.point;
    scene.emit('rayPositionUpdated');
    if (pathController) {
        return;
    }
    pathController = true;
});   

arrival.addEventListener('raycaster-intersected', function(){
    scene.emit('winner');
});
    
function changePathControllerToFalse() {
    console.log('sei uscito dal percorso prima di rilasciare il pulsante!');
    pathController = false;
    spStop.setAttribute('position','8 0 -4');
    spStop.setAttribute('visible','true');
    path.setAttribute('color','green');   
    scene.emit('finished');
    return;
}

function winnerFunction(){
    console.log('intersecato sfera finale!!');
    var scritta=document.createElement('a-text');
    scritta.setAttribute('color', 'red');
    scritta.setAttribute('position', '0 2 -4');
    scritta.setAttribute('value', 'COMPLIMENTI! SEI RIUSCITO A FINIRE IL LIVELLO!!!!');
    scene.appendChild(scritta);
}
    
function updateSpherePosition(){
    spPosition=rayPosition;
    path.setAttribute('color', 'green');
    spStop.setAttribute('visible', true);
    spStop.setAttribute('position', spPosition);    
    controller.removeChild(r1);
    scene.emit('updateFinished');
}
    
function doTrackpadUp(){
    console.log('trackpad rilasciato sul path');
    controller.appendChild(r1); 
    scene.addEventListener('rayPositionUpdated', updateSpherePosition);
    scene.addEventListener('updateFinished', function(){
            scene.removeEventListener('rayPositionUpdated', updateSpherePosition);
    });
    scene.emit('finished');
    console.log('funzione trackpad up finita!');
}
    
controller.addEventListener('trackpaddown', function() {
    if(focused){
        console.log('cliccato sulla pallina iniziale');
        spStop.setAttribute("visible", false);
        path.setAttribute('color', 'yellow');
        
        scene.addEventListener('winner', winnerFunction);
        
        path.addEventListener('raycaster-intersected-cleared', changePathControllerToFalse);
        
        controller.addEventListener('trackpadup', doTrackpadUp);
        
        scene.addEventListener('finished', function closeEventListeners(){
            scene.removeEventListener('winner', winnerFunction);
            controller.removeEventListener('trackpadup', doTrackpadUp);
            path.removeEventListener('raycaster-intersected-cleared', changePathControllerToFalse);
            console.log('evento emesso e rimossi i listener');
        });
        
        
    }
    else return;
});
    
</script>
</body>